<!DOCTYPE html>
<html>
<head>
    <title>Mapbox GL JS debug page</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- <link rel='stylesheet' href='../dist/mapbox-gl.css' /> -->
    <style>
        #map { width: 960px; height: 540px; }
    </style>
</head>

<body>
<div id='map'></div>

<script src='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.js'></script>
<script src='https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css' rel='stylesheet' />

<script type="module">
import loadEncoder from 'https://unpkg.com/mp4-h264@1.0.7/build/mp4-encoder.js';
import {simd} from 'https://unpkg.com/wasm-feature-detect?module';

const feature = {"type":"Feature","properties":{"elevations":[969.3,969.3,966.4,965.1,962.5,959.7,958.2,957.8,957.6,957.6,957.4,957.1,956.9,957.9,958.9,959.4,960.3,962.5,964.9,967.7,969.4,969.4,972.2,976.1,978.4,980.1,984,985.8,987.8,987.8,988.9,989.9,991.9,991.2,992.7,994.4,997,998.9,1001.6,1002.1,1002.9,1003.2,1005.1,1006.4,1007.5,1011.7,1011.7,1011.7,1015.1,1016.3,1018.3,1018.3,1019,1021.8,1021.8,1022.9,1026.2,1027.1,1027.5,1029.5,1029.4,1031.4,1033.5,1033.5,1035.1,1037,1037,1037.5,1039,1039.3,1040.6,1043.6,1049,1049.5,1051.5,1053.4,1053.4,1053.4,1053.5,1053.6,1055.8,1057.9,1057.9,1060.7,1062.3,1062.4,1064.7,1066.6,1068.2,1070.2,1072.4,1074.4,1074.6,1076.3,1078,1078,1079.8,1081.4,1081.4,1083.1,1084.4,1085.6,1084,1082.9,1084.3,1085.4,1085.2,1086.2,1087.5,1090.4,1091.7,1092.7,1094.6,1097.8,1098,1100.4,1101.1,1101.4,1102.3,1102.7,1103.3,1104.6,1106.1,1107.2,1107.8,1109,1109.8,1110.3,1113.9,1116.8,1118.4,1119.4,1120.4,1120.3,1119.8,1117.6,1117.2,1116.3,1113,1109.6,1108.9,1109,1107.4,1105.7,1105,1104.5,1104.3,1103.2,1101,1099.9,1099.2,1097.3,1096.6,1094.3,1092.9,1092.1,1091.3,1092,1092.1,1091.1,1089.7,1088.3,1087.5,1087.8,1089.4,1087.1,1085.9,1085.2,1084.9,1082.9,1082.9,1080.5,1079.1,1077.9,1076,1074.3,1071.4,1068.9,1064,1061.4,1058.8,1058.1,1057.7,1056.2,1055.2,1054,1052.2,1051.6,1051.6,1051.6,1051.8,1052.2,1053.2,1054.5,1055.8,1056.8,1056.8,1056.6,1056.5,1056.4,1056.4,1056.3,1056.7,1056.7,1057.3,1060.1,1062.7,1064.6,1065.7,1066.4,1066.4],"geocode":[{"id":"poi.618475319981","type":"Feature","place_type":["poi"],"relevance":1,"properties":{"foursquare":"508315d0e4b03eedbe7aef45","landmark":true,"category":"mountain, peak, natural"},"text":"Tesnatee Gap","place_name":"Tesnatee Gap, Cleveland, Georgia 30528, United States","center":[-83.847982,34.726039],"geometry":{"coordinates":[-83.847982,34.726039],"type":"Point"},"context":[{"id":"postcode.17725715986680700","text":"30528"},{"id":"place.9352410140423110","wikidata":"Q2376316","text":"Cleveland"},{"id":"district.9293505121729290","wikidata":"Q389365","text":"White County"},{"id":"region.10288430666212700","wikidata":"Q1428","short_code":"US-GA","text":"Georgia"},{"id":"country.19678805456372290","wikidata":"Q30","short_code":"us","text":"United States"}]},{"id":"postcode.17725715986680700","type":"Feature","place_type":["postcode"],"relevance":1,"properties":{},"text":"30528","place_name":"Cleveland, Georgia 30528, United States","bbox":[-83.9956139983778,34.5035960082076,-83.615514993478,34.7408609233911],"center":[-83.75,34.6],"geometry":{"type":"Point","coordinates":[-83.75,34.6]},"context":[{"id":"place.9352410140423110","wikidata":"Q2376316","text":"Cleveland"},{"id":"district.9293505121729290","wikidata":"Q389365","text":"White County"},{"id":"region.10288430666212700","wikidata":"Q1428","short_code":"US-GA","text":"Georgia"},{"id":"country.19678805456372290","wikidata":"Q30","short_code":"us","text":"United States"}]},{"id":"place.9352410140423110","type":"Feature","place_type":["place"],"relevance":1,"properties":{"wikidata":"Q2376316"},"text":"Cleveland","place_name":"Cleveland, Georgia, United States","bbox":[-83.995613997,34.488197007,-83.615538002,34.740860954],"center":[-83.7633,34.5972],"geometry":{"type":"Point","coordinates":[-83.7633,34.5972]},"context":[{"id":"district.9293505121729290","wikidata":"Q389365","text":"White County"},{"id":"region.10288430666212700","wikidata":"Q1428","short_code":"US-GA","text":"Georgia"},{"id":"country.19678805456372290","wikidata":"Q30","short_code":"us","text":"United States"}]},{"id":"district.9293505121729290","type":"Feature","place_type":["district"],"relevance":1,"properties":{"wikidata":"Q389365"},"text":"White County","place_name":"White County, Georgia, United States","bbox":[-83.877418,34.503602,-83.615517,34.801518],"center":[-83.75,34.68333],"geometry":{"type":"Point","coordinates":[-83.75,34.68333]},"context":[{"id":"region.10288430666212700","wikidata":"Q1428","short_code":"US-GA","text":"Georgia"},{"id":"country.19678805456372290","wikidata":"Q30","short_code":"us","text":"United States"}]},{"id":"region.10288430666212700","type":"Feature","place_type":["region"],"relevance":1,"properties":{"wikidata":"Q1428","short_code":"US-GA"},"text":"Georgia","place_name":"Georgia, United States","bbox":[-85.6051655439992,30.3557560056524,-80.7014168670616,35.0013039996912],"center":[-83.2572560296474,32.3305706594],"geometry":{"type":"Point","coordinates":[-83.2572560296474,32.3305706594]},"context":[{"id":"country.19678805456372290","wikidata":"Q30","short_code":"us","text":"United States"}]},{"id":"country.19678805456372290","type":"Feature","place_type":["country"],"relevance":1,"properties":{"wikidata":"Q30","short_code":"us"},"text":"United States","place_name":"United States","bbox":[-179.9,18.8163608007951,-66.8847646185949,71.4202919997506],"center":[-97.9222112121185,39.3812661305678],"geometry":{"type":"Point","coordinates":[-97.9222112121185,39.3812661305678]}}],"min_elevation":956.9,"max_elevation":1120.4,"elevation_difference":97.10000000000014},"geometry":{"type":"LineString","coordinates":[[-83.8481151,34.7259356],[-83.848092,34.725951],[-83.847979,34.726035],[-83.847919,34.726059],[-83.847836,34.726041],[-83.847776,34.725999],[-83.847705,34.725946],[-83.847657,34.725975],[-83.84761,34.726011],[-83.84758,34.72607],[-83.847544,34.726166],[-83.847503,34.726183],[-83.847467,34.726183],[-83.847354,34.726172],[-83.847289,34.726172],[-83.847241,34.726142],[-83.847199,34.726154],[-83.847104,34.726172],[-83.846979,34.726124],[-83.846926,34.72613],[-83.846878,34.726178],[-83.846842,34.726178],[-83.846765,34.726136],[-83.846616,34.726041],[-83.846515,34.726011],[-83.846414,34.725951],[-83.846307,34.72585],[-83.846224,34.725791],[-83.846194,34.725785],[-83.846182,34.725797],[-83.84617,34.725821],[-83.846135,34.725803],[-83.846099,34.725779],[-83.846063,34.725725],[-83.846016,34.725731],[-83.845998,34.725761],[-83.845992,34.725838],[-83.845992,34.725904],[-83.845974,34.725928],[-83.845974,34.725969],[-83.845968,34.726029],[-83.845956,34.726065],[-83.845914,34.726065],[-83.845873,34.726005],[-83.845813,34.725928],[-83.845718,34.725856],[-83.845688,34.725862],[-83.845688,34.72588],[-83.845665,34.725922],[-83.845641,34.725999],[-83.845617,34.726023],[-83.845617,34.726017],[-83.845563,34.725951],[-83.845498,34.725892],[-83.84548,34.725916],[-83.845468,34.72594],[-83.845462,34.725993],[-83.84545,34.72607],[-83.845427,34.726124],[-83.845409,34.726136],[-83.845391,34.726112],[-83.845355,34.726112],[-83.845331,34.72613],[-83.845308,34.726172],[-83.845278,34.726243],[-83.845248,34.726261],[-83.845224,34.726255],[-83.845212,34.726189],[-83.845177,34.726065],[-83.845135,34.725969],[-83.845082,34.725951],[-83.84504,34.725963],[-83.844992,34.726005],[-83.844957,34.72607],[-83.844933,34.726142],[-83.844879,34.726172],[-83.844879,34.726207],[-83.844897,34.726243],[-83.844891,34.726279],[-83.844879,34.726326],[-83.844844,34.726398],[-83.844808,34.726398],[-83.844796,34.72638],[-83.844772,34.726297],[-83.844725,34.726219],[-83.844701,34.726136],[-83.844665,34.726023],[-83.844635,34.725975],[-83.844606,34.725981],[-83.844558,34.726041],[-83.844511,34.72613],[-83.844475,34.726207],[-83.844445,34.726338],[-83.844421,34.726368],[-83.844386,34.726368],[-83.844356,34.726332],[-83.844332,34.726332],[-83.844308,34.72635],[-83.84429,34.72635],[-83.844255,34.726273],[-83.844207,34.72613],[-83.84416,34.725981],[-83.844148,34.72588],[-83.844142,34.725827],[-83.844106,34.725815],[-83.844058,34.725815],[-83.844023,34.725797],[-83.843987,34.725797],[-83.843969,34.725827],[-83.843963,34.725898],[-83.843951,34.725963],[-83.843934,34.726047],[-83.843904,34.726088],[-83.843809,34.726136],[-83.843797,34.726178],[-83.843743,34.726213],[-83.843707,34.726213],[-83.843642,34.726154],[-83.843559,34.726112],[-83.843505,34.72607],[-83.843422,34.725969],[-83.843249,34.725797],[-83.843166,34.725684],[-83.843124,34.725559],[-83.843095,34.725499],[-83.842958,34.725434],[-83.842815,34.725363],[-83.84272,34.725351],[-83.842619,34.725357],[-83.842482,34.725363],[-83.842417,34.725386],[-83.842381,34.72541],[-83.842333,34.72541],[-83.842256,34.725386],[-83.842089,34.725297],[-83.841929,34.725208],[-83.84184,34.725202],[-83.841744,34.725184],[-83.841566,34.725095],[-83.841453,34.724994],[-83.841399,34.724964],[-83.841322,34.724946],[-83.841245,34.724893],[-83.841161,34.724791],[-83.841084,34.72475],[-83.840995,34.724762],[-83.840977,34.724791],[-83.840965,34.72491],[-83.840947,34.72497],[-83.840918,34.724976],[-83.840864,34.724952],[-83.840781,34.724905],[-83.840709,34.724863],[-83.840614,34.724815],[-83.840561,34.724803],[-83.840561,34.724833],[-83.840567,34.724881],[-83.840602,34.724928],[-83.840632,34.724994],[-83.840632,34.725047],[-83.84059,34.725071],[-83.840555,34.725065],[-83.840525,34.725012],[-83.840459,34.724928],[-83.840406,34.724786],[-83.840293,34.724696],[-83.840263,34.724696],[-83.840263,34.72472],[-83.840287,34.724821],[-83.840299,34.724922],[-83.840341,34.725],[-83.840329,34.725113],[-83.840281,34.725137],[-83.840245,34.725131],[-83.840174,34.725095],[-83.840091,34.725053],[-83.839966,34.725029],[-83.839847,34.725012],[-83.839716,34.72497],[-83.839615,34.724964],[-83.839532,34.724976],[-83.83946,34.725047],[-83.83943,34.725119],[-83.839371,34.725166],[-83.8393,34.72519],[-83.839258,34.725214],[-83.839198,34.72522],[-83.839151,34.725244],[-83.839107,34.725298],[-83.839103,34.725303],[-83.839115,34.725351],[-83.839145,34.72538],[-83.839216,34.725446],[-83.839335,34.725565],[-83.839526,34.725702],[-83.839722,34.725821],[-83.839877,34.72591],[-83.839888,34.725975],[-83.839877,34.726023],[-83.839853,34.726047],[-83.839853,34.726047],[-83.839853,34.72607],[-83.839841,34.726112],[-83.839833,34.726112],[-83.839787,34.726112],[-83.839639,34.726148],[-83.839526,34.726201],[-83.839436,34.726255],[-83.839395,34.726332],[-83.839365,34.726445],[-83.8393323,34.726479]]}};
const data = feature.geometry;
// const data = {"type":"LineString","coordinates":[[-79.3325275,37.631786],[-79.332665,37.631668],[-79.332787,37.63158],[-79.332951,37.631479],[-79.333125,37.63139],[-79.333905,37.631044],[-79.3339799,37.63101],[-79.334326,37.630853],[-79.334382,37.630822],[-79.334515,37.630735],[-79.334635,37.630637],[-79.334751,37.630519],[-79.334824,37.630422],[-79.33488,37.630319],[-79.334913,37.630233],[-79.334939,37.630122],[-79.334946,37.629983],[-79.334933,37.629864],[-79.334903,37.629747],[-79.334844,37.629611],[-79.334752,37.629475],[-79.334597,37.62928],[-79.334421,37.629097],[-79.334189,37.628891],[-79.334011,37.628709],[-79.33388,37.628557],[-79.333723,37.628353],[-79.333648,37.628231],[-79.333591,37.628103],[-79.333533,37.627908],[-79.333505,37.627758],[-79.333495,37.627606],[-79.3335,37.627484],[-79.333523,37.627333],[-79.333591,37.627105],[-79.333684,37.626861],[-79.333794,37.626622],[-79.333895,37.626434],[-79.334207,37.625797],[-79.334482,37.625185],[-79.33463,37.624877],[-79.334711,37.62466],[-79.334724,37.624625],[-79.334758,37.624489],[-79.334776,37.624351],[-79.334775,37.624213],[-79.334762,37.624103],[-79.33472,37.62392],[-79.334654,37.623668],[-79.334569,37.623419],[-79.334467,37.623175],[-79.334261,37.622766],[-79.334139,37.622543],[-79.334007,37.622324],[-79.333794,37.621999],[-79.333664,37.621821],[-79.33355,37.621684],[-79.333394,37.62152],[-79.333251,37.62139],[-79.333048,37.621232],[-79.332832,37.621085],[-79.332478,37.620873],[-79.332274,37.620734],[-79.332026,37.62054],[-79.33189,37.620424],[-79.331675,37.620224],[-79.33144,37.619981],[-79.3312021,37.6197158]]};

mapboxgl.accessToken = 'pk.eyJ1IjoiamNzYW5mb3JkIiwiYSI6ImNrZG1kdnU5NzE3bG4yenBkbzU5bDQ2NXMifQ.IMquilPKSANQDaSzf3fjcg';
const map = window.map = new mapboxgl.Map({
    container: 'map',
    center: data.coordinates[0],
    zoom: 15,
    pitch: 62,
    bearing: 140,
    // style: 'mapbox://styles/mapbox/satellite-v9'
    // style: 'mapbox://styles/jcsanford/cks3bzm7c1ylb17nz0zp4fted'
    style: 'mapbox://styles/jcsanford/ckskfetbk072c18lq5eqjwc6z'
});

map.on('load', async () => {
    map.addSource('dem', {type: 'raster-dem', url: 'mapbox://mapbox.mapbox-terrain-dem-v1'});
    map.setTerrain({source: 'dem', exaggeration: 1.5});
    map.setFog({
      'range': [0.5, 10],
      'color': 'white',
      'horizon-blend': 0.1
    });
    map.addSource('route', {
      type: 'geojson',
      data: { type: 'LineString', coordinates: []}
    });
    map.addLayer({
      'id': 'route',
      'type': 'line',
      'source': 'route',
      'layout': {
        'line-join': 'round',
        'line-cap': 'round'
      },
      'paint': {
        'line-color': '#ff7800',
        'line-width': 5,
        'line-opacity': 0.8
      }
    });

    const coordinates = data.coordinates;

    // start by showing just the first coordinate
    data.coordinates = [coordinates[0]];

    async function animate() {
      return new Promise((resolve, reject) => {
        let i = 0;
        const timer = setInterval(async () => {
          if (i < coordinates.length) {
            data.coordinates.push(coordinates[i]);
            map.getSource('route').setData(data);
            map.panTo(coordinates[i]);
            // Do we need this?
            await map.once('moveend');
            i++;
          } else {
            window.clearInterval(timer);
            resolve('ok');
          }
        }, 250);
      });
      // await map.once('moveend');
    }
    // const startAnimatingRoute = () => {
    //   let i = 0;
    //   const timer = setInterval(() => {
    //     if (i < coordinates.length) {
    //       data.coordinates.push(coordinates[i]);
    //       map.getSource('route').setData(data);
    //       map.panTo(coordinates[i]);
    //       i++;
    //     } else {
    //       window.clearInterval(timer);
    //     }
    //   }, 100);
    // };
    // setTimeout(startAnimatingRoute, 2000);
    await map.once('idle');

    // uncomment to fine-tune animation without recording:
    // animate(); return;

    // don't forget to enable WebAssembly SIMD in chrome://flags for faster encoding
    const supportsSIMD = await simd();

    // initialize H264 video encoder
    const Encoder = await loadEncoder({simd: supportsSIMD});

    const gl = map.painter.context.gl;
    const width = gl.drawingBufferWidth;
    const height = gl.drawingBufferHeight;

    const encoder = Encoder.create({
        width,
        height,
        fps: 60,
        kbps: 64000,
        rgbFlipY: true
    });

    // stub performance.now for deterministic rendering per-frame (only available in dev build)
    let now = performance.now();
    mapboxgl.setNow(now);

    const ptr = encoder.getRGBPointer(); // keep a pointer to encoder WebAssembly heap memory

    function frame() {
        // increment stub time by 16.6ms (60 fps)
        now += 1000 / 60;
        mapboxgl.setNow(now);

        const pixels = encoder.memory().subarray(ptr); // get a view into encoder memory
        gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels); // read pixels into encoder
        encoder.encodeRGBPointer(); // encode the frame
    }

    map.on('render', frame); // set up frame-by-frame recording

    await animate(); // run all the animations

    // stop recording
    map.off('render', frame);
    mapboxgl.restoreNow();

    // download the encoded video file
    const mp4 = encoder.end();
    const anchor = document.createElement("a");
    anchor.href =  URL.createObjectURL(new Blob([mp4], {type: "video/mp4"}));
    anchor.download = "mapbox-gl";
    anchor.click();

    // make sure to run `ffmpeg -i mapbox-gl.mp4 mapbox-gl-optimized.mp4` to compress the video
});

</script>
</body>
</html>
